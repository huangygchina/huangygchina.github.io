---
layout:     post
title:      微服务
subtitle:   微服务架构的优势与不足
date:       2019-07-02
author:     火花
header-img: img/post-bg-ios9-web.jpg
catalog: true
tags:
    - 架构
---

**什么是微服务**

微服务架构是一种架构模式，它提倡将单一应用程序划分成一组小的服务，服务之间相互协调、互相配合，为用户提供最终价值。

每种应用程序都在其自己的进程中运行，并与轻量级机制（通常是HTTP资源的API）进行通信。
这些服务是围绕业务功能构建的，可以通过全自动部署机制进行独立部署。
它们可以用不同的编程语言编写，并使用不同的数据存储技术。

**开发单体应用：**

- 应用核心是业务逻辑，由定义服务、域对象和事件的模块完成。
- 围绕着核心的是与外界打交道的适配器。适配器包括数据库访问组件、生产和处理消息的消息组件，以及提供API或者UI访问支持的web模块等。
- 管也是模块化逻辑，但是最终它还是会打包并部署为单体式应用。
- 许多Java应用会被打包为WAR格式，部署在Tomcat上。
- 单体式应用也易于部署，只需要把打包应用拷贝到服务器端，通过在负载均衡器后端运行多个拷贝就可以轻松实现应用扩展。在早期这类应用运行的很好。

**单体式应用的不足**

- 一个简单的应用会随着时间推移逐渐变大。几年后，这个小而简单的应用会变成了一个巨大的怪物。一旦你的应用变成一个又大又复杂的怪物，那开发团队肯定很痛苦。其中最主要问题就是这个应用太复杂，以至于任何单个开发者都不可能搞懂它。修正bug和正确的添加新功能变的非常困难，并且很耗时。
- 复杂而巨大的单体式应用也不利于持续性开发。今天，SaaS应用常态就是每天会改变很多次，而这对于单体式应用模式非常困难。另外，这种变化带来的影响并没有很好的被理解，所以不得不做很多手工测试。那么接下来，持续部署也会很艰难。
- 单体式应用另外一个问题是可靠性。因为所有模块都运行在一个进程中，任何一个模块中的一个bug，比如内存泄露，将会有可能弄垮整个进程。除此之外，因为所有应用实例都是唯一的，这个bug将会影响到整个应用的可靠性。
- 单体式应用使得采用新架构和语言非常困难。比如，设想你有两百万行采用XYZ框架写的代码。如果想改成ABC框架，无论是时间还是成本都是非常昂贵的，即使ABC框架更好。因此，这是一个无法逾越的鸿沟。你不得不在最初选择面前低头。

**微服务架构**

1. 一个微服务一般完成某个特定的功能，比如下单管理、客户管理等等。
1. 每一个微服务都是微型六角形应用，都有自己的业务逻辑和适配器。
1. 一些微服务还会发布API给其它微服务和应用客户端使用。
1. 其它微服务完成一个Web UI，运行时，每一个实例可能是一个云VM或者是Docker容器。
1. 每一个后台服务开放一个REST API，许多服务本身也采用了其它服务提供的API。
1. 这些应用并不直接访问后台服务，而是通过API Gateway来传递中间消息。
1. API Gateway负责负载均衡、缓存、访问控制、API 计费监控等等任务。
1. 应用基本可以用以上三个维度来表示，Y轴代表将应用分解为微服务。运行时，X轴代表运行多个隐藏在负载均衡器之后的实例，提供吞吐能力。一些应用可能还是用Z轴将服务分区。
1. 运行时，行程管理服务由多个服务实例构成。每一个服务实例都是一个Docker容器。为了保证高可用，这些容器一般都运行在多个云VM上。
1. 服务实例前是一层诸如NGINX的负载均衡器，他们负责在各个实例间分发请求。负载均衡器也同时处理其它请求，例如缓存、权限控制、API统计和监控。
1. 微服务架构模式深刻影响了应用和数据库之间的关系，不像传统多个服务共享一个数据库，微服务架构每个服务都有自己的数据库。
1. 同时，这种模式意味着多份数据，但是，如果你想获得微服务带来的好处，每个服务独有一个数据库是必须的，因为这种架构需要这种松耦合。

**微服务的优点**

1. 通过分解巨大单体式应用为多个服务方法解决了复杂性问题。单个服务很容易开发、理解和维护。
2. 这种架构使得每个服务都可以有专门开发团队来开发。开发者可以自由选择开发技术，提供API服务。这种自由意味着开发者不需要被迫使用某项目开始时采用的过时技术，他们可以选择现在的技术。
3. 微服务架构模式是每个微服务独立的部署。开发者不再需要协调其它服务部署对本服务的影响。这种改变可以加快部署速度。
4. 微服务架构模式使得每个服务独立扩展。你可以根据每个服务的规模来部署满足需求的规模。甚至于，你可以使用更适合于服务资源需求的硬件。


**微服务的不足**

1. 微服务应用是分布式系统，由此会带来固有的复杂性。开发者需要在RPC或者消息传递之间选择并完成进程间通讯机制。更甚于，他们必须写代码来处理消息传递中速度过慢或者不可用等局部失效问题。当然这并不是什么难事，但相对于单体式应用中通过语言层级的方法或者进程调用，微服务下这种技术显得更复杂一些。
2. 另外一个关于微服务的挑战来自于分区的数据库架构。商业交易中同时给多个业务分主体更新数据很普遍。这对于单体式应用来说很容易，因为只有一个数据库。在微服务架构应用中，需要更新不同服务所使用的不同的数据库。
3. 测试一个基于微服务架构的应用也是很复杂的任务。比如，采用流行的Spring Boot架构，对一个单体式web应用，测试它的REST API，是很容易的事情。反过来，同样的服务测试需要启动和它有关的所有服务（至少需要这些服务的stubs）。再重申一次，不能低估了采用微服务架构带来的复杂性。
4. 微服务架构模式应用的改变将会波及多个服务。比如，假设你在完成一个案例，需要修改服务A、B、C，而A依赖B，B依赖C。在单体式应用中，你只需要改变相关模块，整合变化，部署就好了。对比之下，微服务架构模式就需要考虑相关改变对不同服务的影响。比如，你需要更新服务C，然后是B，最后才是A，幸运的是，许多改变一般只影响一个服务，而需要协调多服务的改变很少。
5. 部署一个微服务应用也很复杂，一个分布式应用只需要简单在复杂均衡器后面部署各自的服务器就好了。每个应用实例是需要配置诸如数据库和消息中间件等基础服务。相对比，一个微服务应用一般由大批服务构成。